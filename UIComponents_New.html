<script>
/**
 * UI_COMPONENTS.HTML - NEW DASHBOARD
 * Module qu·∫£n l√Ω c√°c UI components v√† rendering logic
 */

const UIComponents = {

  // Cache DOM elements
  elements: {
    sidebar: null,
    mainWrapper: null,
    menuList: null,
    mainContent: null,
    overlay: null,
    breadcrumb: null
  },

  // UI State
  state: {
    activeTab: CLIENT_CONFIG.ui.defaultTab,
    isCollapsed: false,
    isMobile: false
  },

  /**
   * Initialize v√† cache t·∫•t c·∫£ DOM elements
   */
  init: function() {
    this.elements.sidebar = document.getElementById('sidebar');
    this.elements.mainWrapper = document.getElementById('mainWrapper');
    this.elements.menuList = document.getElementById('menuList');
    this.elements.mainContent = document.getElementById('mainContent');
    this.elements.overlay = document.getElementById('overlay');
    this.elements.breadcrumb = document.querySelector('#breadcrumb span');

    this.state.isMobile = window.innerWidth <= CLIENT_CONFIG.ui.mobileBreakpoint;
  },

  /**
   * Render menu items v√†o sidebar
   */
  renderMenu: function() {
    const menuHtml = CLIENT_CONFIG.menuItems.map(item => `
      <li class="menu-item ${item.id === this.state.activeTab ? 'active' : ''}"
          onclick="App.navigate('${item.id}')"
          title="${this.state.isCollapsed ? item.label : ''}">
        <i class="material-icons-outlined">${item.icon}</i>
        <span>${item.label}</span>
      </li>
    `).join('');

    this.elements.menuList.innerHTML = menuHtml;
  },

  /**
   * ===================================================================
   * NEW DASHBOARD COMPONENTS
   * ===================================================================
   */

  /**
   * Render B·ªò L·ªåC NG√ÄY/TU·∫¶N/TH√ÅNG/NƒÇM
   */
  renderDateFilter: function() {
    const today = new Date().toISOString().split('T')[0];

    return `
      <div class="date-filter-container">
        <div class="filter-header">
          <h3>üìÖ B·ªô l·ªçc th·ªùi gian</h3>
        </div>
        <div class="filter-controls">
          <div class="filter-buttons">
            <button class="filter-btn active" data-type="day" onclick="App.changeFilterType('day')">
              <i class="material-icons-outlined">today</i>
              <span>Ng√†y</span>
            </button>
            <button class="filter-btn" data-type="week" onclick="App.changeFilterType('week')">
              <i class="material-icons-outlined">date_range</i>
              <span>Tu·∫ßn</span>
            </button>
            <button class="filter-btn" data-type="month" onclick="App.changeFilterType('month')">
              <i class="material-icons-outlined">calendar_month</i>
              <span>Th√°ng</span>
            </button>
            <button class="filter-btn" data-type="year" onclick="App.changeFilterType('year')">
              <i class="material-icons-outlined">calendar_today</i>
              <span>NƒÉm</span>
            </button>
          </div>

          <div class="filter-date-picker">
            <input type="date" id="filterDate" value="${today}" onchange="App.applyDateFilter()"
                   class="date-input">
            <button onclick="App.resetFilter()" class="btn-reset">
              <i class="material-icons-outlined">refresh</i>
              Reset
            </button>
          </div>
        </div>
      </div>
    `;
  },

  /**
   * Render 4 CARDS T·ªîNG QUAN
   */
  renderOverviewCards: function(data) {
    if (!data) {
      data = { soChuyen: 0, soXe: 0, doanhThu: 0, soKhachHang: 0 };
    }

    return `
      <div class="stats-container">
        <!-- Card 1: S·ªë chuy·∫øn ƒëi -->
        <div class="stat-card">
          <div class="stat-info">
            <h3 id="metric-trips">${data.soChuyen.toLocaleString('vi-VN')}</h3>
            <span>S·ªë l∆∞·ª£ng chuy·∫øn ƒëi</span>
          </div>
          <div class="stat-icon" style="background: #e3f2fd; color: #2962ff;">
            <i class="material-icons-outlined">local_shipping</i>
          </div>
        </div>

        <!-- Card 2: S·ªë xe s·ª≠ d·ª•ng -->
        <div class="stat-card">
          <div class="stat-info">
            <h3 id="metric-vehicles">${data.soXe.toLocaleString('vi-VN')}</h3>
            <span>S·ªë l∆∞·ª£ng xe s·ª≠ d·ª•ng</span>
          </div>
          <div class="stat-icon" style="background: #e8f5e9; color: #2e7d32;">
            <i class="material-icons-outlined">directions_car</i>
          </div>
        </div>

        <!-- Card 3: Doanh thu -->
        <div class="stat-card">
          <div class="stat-info">
            <h3 id="metric-revenue">${data.doanhThu.toLocaleString('vi-VN')} ‚Ç´</h3>
            <span>T·ªïng doanh thu</span>
          </div>
          <div class="stat-icon" style="background: #fff3e0; color: #ef6c00;">
            <i class="material-icons-outlined">attach_money</i>
          </div>
        </div>

        <!-- Card 4: Kh√°ch h√†ng -->
        <div class="stat-card">
          <div class="stat-info">
            <h3 id="metric-customers">${data.soKhachHang.toLocaleString('vi-VN')}</h3>
            <span>S·ªë kh√°ch h√†ng ph·ª•c v·ª•</span>
          </div>
          <div class="stat-icon" style="background: #fce4ec; color: #c2185b;">
            <i class="material-icons-outlined">people</i>
          </div>
        </div>
      </div>
    `;
  },

  /**
   * Render B·∫¢NG TOP KH√ÅCH H√ÄNG
   */
  renderTopCustomersTable: function(customers) {
    if (!customers || customers.length === 0) {
      return '<div class="no-data"><i class="material-icons-outlined">inbox</i><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div>';
    }

    const rows = customers.map((c, index) => `
      <tr>
        <td class="rank-cell">#${index + 1}</td>
        <td><strong>${c.ten_khach_hang || c.ma_khach_hang}</strong></td>
        <td class="number-cell">${parseInt(c.so_chuyen).toLocaleString('vi-VN')}</td>
        <td class="revenue-cell"><strong>${parseInt(c.tong_doanh_thu).toLocaleString('vi-VN')} ‚Ç´</strong></td>
      </tr>
    `).join('');

    return `
      <div class="table-container">
        <table class="report-table">
          <thead>
            <tr>
              <th width="50">#</th>
              <th>Kh√°ch h√†ng</th>
              <th width="120">S·ªë chuy·∫øn</th>
              <th width="180">Doanh thu</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  },

  /**
   * Render B·∫¢NG TOP TUY·∫æN
   */
  renderTopRoutesTable: function(routes) {
    if (!routes || routes.length === 0) {
      return '<div class="no-data"><i class="material-icons-outlined">inbox</i><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div>';
    }

    const rows = routes.map((r, index) => `
      <tr>
        <td class="rank-cell">#${index + 1}</td>
        <td><strong>${r.tuyen}</strong></td>
        <td class="number-cell">${parseInt(r.so_chuyen).toLocaleString('vi-VN')}</td>
        <td class="revenue-cell"><strong>${parseInt(r.tong_doanh_thu).toLocaleString('vi-VN')} ‚Ç´</strong></td>
      </tr>
    `).join('');

    return `
      <div class="table-container">
        <table class="report-table">
          <thead>
            <tr>
              <th width="50">#</th>
              <th>Tuy·∫øn giao h√†ng</th>
              <th width="120">S·ªë chuy·∫øn</th>
              <th width="180">Doanh thu</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  },

  /**
   * Render B·∫¢NG TOP XE
   */
  renderTopVehiclesTable: function(vehicles, isBottom) {
    if (!vehicles || vehicles.length === 0) {
      return '<div class="no-data"><i class="material-icons-outlined">inbox</i><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div>';
    }

    const rows = vehicles.map((v, index) => `
      <tr>
        <td class="rank-cell">#${index + 1}</td>
        <td><strong>${v.bien_kiem_soat}</strong></td>
        <td class="number-cell">${parseInt(v.so_chuyen).toLocaleString('vi-VN')}</td>
        <td class="revenue-cell"><strong>${parseInt(v.tong_doanh_thu).toLocaleString('vi-VN')} ‚Ç´</strong></td>
        <td class="number-cell">${parseInt(v.doanh_thu_trung_binh).toLocaleString('vi-VN')} ‚Ç´</td>
      </tr>
    `).join('');

    return `
      <div class="table-container">
        <table class="report-table">
          <thead>
            <tr>
              <th width="50">#</th>
              <th>Bi·ªÉn ki·ªÉm so√°t</th>
              <th width="100">S·ªë chuy·∫øn</th>
              <th width="150">T·ªïng doanh thu</th>
              <th width="150">TB/chuy·∫øn</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  },

  /**
   * Render TO√ÄN B·ªò DASHBOARD M·ªöI
   */
  renderNewDashboard: function() {
    return `
      ${this.renderDateFilter()}

      <div id="overview-cards">
        <div class="loading-state">
          <i class="material-icons-outlined rotating">sync</i>
          <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
      </div>

      <div class="dashboard-sections">
        <!-- SECTION: B√ÅO C√ÅO KH√ÅCH H√ÄNG -->
        <div class="dashboard-section">
          <h2 class="section-title">
            <i class="material-icons-outlined">people</i>
            B√°o c√°o Kh√°ch h√†ng
          </h2>
          <div class="report-grid">
            <div class="report-card">
              <h3 class="report-card-title">üèÜ Top 10 Kh√°ch h√†ng</h3>
              <div id="top-customers" class="report-content">
                <div class="loading-state-small">ƒêang t·∫£i...</div>
              </div>
            </div>
            <div class="report-card">
              <h3 class="report-card-title">üõ£Ô∏è Top 10 Tuy·∫øn</h3>
              <div id="top-routes" class="report-content">
                <div class="loading-state-small">ƒêang t·∫£i...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION: B√ÅO C√ÅO XE -->
        <div class="dashboard-section">
          <h2 class="section-title">
            <i class="material-icons-outlined">local_shipping</i>
            B√°o c√°o Xe
          </h2>
          <div class="report-grid">
            <div class="report-card">
              <h3 class="report-card-title">‚¨ÜÔ∏è Top 10 Xe doanh thu cao nh·∫•t</h3>
              <div id="top-vehicles" class="report-content">
                <div class="loading-state-small">ƒêang t·∫£i...</div>
              </div>
            </div>
            <div class="report-card">
              <h3 class="report-card-title">‚¨áÔ∏è Top 10 Xe doanh thu th·∫•p nh·∫•t</h3>
              <div id="bottom-vehicles" class="report-content">
                <div class="loading-state-small">ƒêang t·∫£i...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  },

  /**
   * Render page "ƒëang ph√°t tri·ªÉn"
   */
  renderUnderConstruction: function(title) {
    return `
      <div class="dev-state">
        <i class="material-icons-outlined" style="font-size: 64px; color: #e0e0e0; margin-bottom: 16px;">construction</i>
        <h2>${title}</h2>
        <p style="color: #888;">T√≠nh nƒÉng <strong>"${title}"</strong> ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.</p>
      </div>
    `;
  },

  /**
   * Update s·ªë li·ªáu l√™n overview cards v·ªõi animation
   */
  updateDashboardStats: function(data) {
    const elTotal = document.getElementById('metric-trips');
    const elVehicles = document.getElementById('metric-vehicles');
    const elRevenue = document.getElementById('metric-revenue');
    const elCustomers = document.getElementById('metric-customers');

    if (elTotal && elVehicles && elRevenue && elCustomers) {
      this._animateValue(elTotal, 0, data.soChuyen, 800);
      this._animateValue(elVehicles, 0, data.soXe, 800);
      this._animateValue(elRevenue, 0, data.doanhThu, 800, ' ‚Ç´');
      this._animateValue(elCustomers, 0, data.soKhachHang, 800);
    }
  },

  /**
   * Animate s·ªë t·ª´ start ƒë·∫øn end
   */
  _animateValue: function(element, start, end, duration, suffix = '') {
    const range = end - start;
    const startTime = performance.now();

    const animate = (currentTime) => {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);

      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(start + (range * easeProgress));

      element.textContent = currentValue.toLocaleString('vi-VN') + suffix;

      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    };

    requestAnimationFrame(animate);
  }
};
</script>
